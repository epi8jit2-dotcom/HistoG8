import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# --- 1. CONFIGURATION ---
st.set_page_config(
    page_title="Epidemic Curve Generator",
    page_icon="ü¶†",
    layout="wide"
)

# --- 2. HELPER FUNCTIONS ---
def load_data(file):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á CSV ‡πÅ‡∏•‡∏∞ Excel"""
    try:
        if file.name.endswith('.csv'):
            return pd.read_csv(file)
        else:
            return pd.read_excel(file)
    except Exception as e:
        st.error(f"Error loading file: {e}")
        return None

def find_date_column(columns):
    """‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"""
    keywords = ['date', 'onset', 'time', '‡∏ß‡∏±‡∏ô', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢', 'report']
    for col in columns:
        if any(keyword in col.lower() for keyword in keywords):
            return col
    return columns[0]  # ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å

# --- 3. MAIN UI ---
st.title("ü¶† Interactive Epidemic Curve Generator")
st.markdown("""
‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ (Epi Curve) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 
‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÅ‡∏•‡∏∞ .csv | ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ Streamlit
""")
st.divider()

# Sidebar: Upload & Settings
with st.sidebar:
    st.header("1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Import Data)")
    uploaded_file = st.file_uploader("Upload Excel/CSV", type=['xlsx', 'csv'])
    
    st.header("2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü (Settings)")

if uploaded_file:
    df = load_data(uploaded_file)
    
    if df is not None:
        # --- PREPROCESSING ---
        # 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        all_cols = list(df.columns)
        default_date_col = find_date_column(all_cols)
        
        date_col = st.sidebar.selectbox(
            "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡πà‡∏ß‡∏¢' (Date of Onset)", 
            all_cols, 
            index=all_cols.index(default_date_col)
        )
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Datetime
        try:
            df[date_col] = pd.to_datetime(df[date_col], dayfirst=True, errors='coerce')
            # ‡∏ï‡∏±‡∏î‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô NaT (‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å) ‡∏ó‡∏¥‡πâ‡∏á
            missing_dates = df[date_col].isna().sum()
            if missing_dates > 0:
                st.sidebar.warning(f"‚ö†Ô∏è ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå {missing_dates} ‡πÅ‡∏ñ‡∏ß (‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å)")
            df = df.dropna(subset=[date_col])
        except Exception as e:
            st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {date_col} ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: {e}")
            st.stop()

        # 2. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Grouping (‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏µ)
        st.sidebar.subheader("‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° (Grouping)")
        group_col = st.sidebar.selectbox(
            "‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏° (Optional)", 
            ["None"] + [c for c in all_cols if c != date_col]
        )
        if group_col == "None": group_col = None

        # 3. ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Time Interval)
        interval = st.sidebar.select_slider(
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Time Unit)",
            options=["Daily", "Weekly", "Monthly"],
            value="Daily"
        )
        
        # --- DATA PROCESSING FOR CHART ---
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'Period' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Group ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if interval == "Daily":
            df['Period'] = df[date_col].dt.date
            x_title = "Date (Daily)"
            hover_fmt = "%d %b %Y"
        elif interval == "Weekly":
            # ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)
            df['Period'] = df[date_col].dt.to_period('W').dt.start_time
            x_title = "Week Starting"
            hover_fmt = "Week of %d %b %Y"
        elif interval == "Monthly":
            df['Period'] = df[date_col].dt.to_period('M').dt.start_time
            x_title = "Month"
            hover_fmt = "%b %Y"

        # --- VISUALIZATION ---
        
        # Layout ‡πÅ‡∏ö‡πà‡∏á 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü ‡∏Ç‡∏ß‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ)
        col_main, col_stat = st.columns([3, 1])
        
        with col_main:
            st.subheader(f"üìà Epidemic Curve ({interval})")
            
            # ‡πÉ‡∏ä‡πâ Plotly Histogram ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Binning ‡πÅ‡∏•‡∏∞ Stack ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°
            if group_col:
                fig = px.histogram(
                    df, 
                    x='Period', 
                    color=group_col,
                    nbins=len(df['Period'].unique()) if interval != 'Daily' else None,
                    title=f"Epidemic Curve by {group_col}",
                    labels={'Period': x_title, 'count': 'Cases'},
                    template="plotly_white"
                )
            else:
                fig = px.histogram(
                    df, 
                    x='Period',
                    title="Epidemic Curve (Total Cases)",
                    labels={'Period': x_title, 'count': 'Cases'},
                    template="plotly_white"
                )

            # ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Epi Curve ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
            fig.update_layout(
                bargap=0.05,  # ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢)
                xaxis_title=x_title,
                yaxis_title="Number of Cases",
                xaxis=dict(
                    type='date', # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏Å‡∏ô X ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
                    tickformat="%d %b" if interval == "Daily" else "%d %b %y"
                )
            )
            
            st.plotly_chart(fig, use_container_width=True)

        with col_stat:
            st.subheader("üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            total_cases = len(df)
            first_case = df[date_col].min().strftime('%d %b %Y')
            last_case = df[date_col].max().strftime('%d %b %Y')
            
            st.metric("Total Cases", f"{total_cases:,}")
            st.markdown(f"**First Case:** {first_case}")
            st.markdown(f"**Last Case:** {last_case}")
            
            # Export Data Button
            if group_col:
                summary_df = df.groupby(['Period', group_col]).size().reset_index(name='Cases')
            else:
                summary_df = df.groupby(['Period']).size().reset_index(name='Cases')
            
            st.dataframe(summary_df, hide_index=True, use_container_width=True)
            
            # CSV Download Logic
            csv = summary_df.to_csv(index=False).encode('utf-8')
            st.download_button(
                label="üì• Download Summary CSV",
                data=csv,
                file_name='epi_curve_data.csv',
                mime='text/csv',
            )

else:
    # ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Upload ‡πÑ‡∏ü‡∏•‡πå
    st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
    st.markdown("""
    ### ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:
    * **Excel (.xlsx) ‡∏´‡∏£‡∏∑‡∏≠ CSV (.csv)**
    * ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå **"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÄ‡∏ä‡πà‡∏ô Date of Onset)
    * (Optional) ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏û‡∏®, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    """)
